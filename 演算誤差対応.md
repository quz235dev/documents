## 演算誤差とその対応

現状、計算書において演算誤差が発生している。

0.1 + 0.2 = 0.30000000000000004

- 小数点 17 位まで出力される
- 末尾の 4 は演算誤差。
- 0.1 も 0.2 も 2 進数で表現できず、近似値同士で加算するため演算誤差が発生する
- 引き算でも発生：0.3 - 0.2 = 0.09999999999999998
- 掛け算でも発生：11.111 \* 5 = 55.55500000000001

現在作成している丸め関数 roundNum()の仕様：

- 小数点以下の桁数が 10 桁未満なら元の値を返
- それ以外は、少数の末尾を四捨五入

実装例：
丸め前:

```
const foo = a + b + c + d
```

丸め対応:

```
const foo = roundNum(roundNum(roundNum(a + b) + c ) + d )
```

upw_pump での実装例：

```
    setFunc(
      mk(p, `設計条件合計`),
      found?.有効 === '〇'
        ? String(roundNum(roundNum(sum揚程目安 + p237) + p238))
        : String(roundNum(roundNum(roundNum(roundNum(sum揚程目安 + p237) + p241) + p239) + p240)),
    )
```

pump での実装例：

```
  return (
    ポンプ揚程目安試算_1 + // 整数
    ポンプ揚程目安試算_2 + // 整数
    ポンプ揚程目安試算_3 + // 整数
    ポンプ揚程目安試算_4 + // 整数
    ポンプ揚程目安試算_5 + // 整数
    ポンプ揚程目安試算_6 + // 整数
    ポンプ揚程目安試算_7 + // 整数
    ポンプ揚程目安試算_8 + // 整数
    ポンプ揚程目安試算_9 + // 整数
    配管_継手圧損 + // 整数
    roundNum(実揚程 + 必要着圧)
  )
```

## 今後の対応案について

システム全体で保証する桁数を定義するのは？
javascript においては整数部+小数部で 17 桁の出力が可能。

#### 一般的に有効といわれる桁数は 15 桁で表現できる範囲

999,999,999,999,999 ～ 0.000000000000001

#### 小数点第三位まで表現する場合の範囲

999,999,999,999.999 ～ 0.001

#### 小数点第五位まで表現する場合の範囲

9,999,999,999.99999 ～ 0.00001

### どうしても精度を確保したい場合にはライブラリを使う

- big.js
- bignumber.js
- decimal.js

big.js の使用例(使い方はどれもだいたい同じ)

```
x = new Big(0.3)
x.div(y).plus(z).times(9).minus('1.234567801234567e+8').plus(976.54321).div('2598.11772')
```

[参考] https://zenn.dev/ymmt1089/articles/20220603_big_number
